
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../APIs/Core/WebSockets/gateway_events/">
      
      
        <link rel="next" href="../chat/">
      
      
      <link rel="icon" href="../../assets/lines.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>polyproto-core - Polyphony</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#polyproto-core-specification" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Polyphony" class="md-header__button md-logo" aria-label="Polyphony" data-md-component="logo">
      
  <img src="../../assets/lines.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Polyphony
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              polyproto-core
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/polyphony-chat/polyproto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../APIs/" class="md-tabs__link">
          
  
    
  
  APIs

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
    
  
  Protocol Specifications

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Polyphony" class="md-nav__button md-logo" aria-label="Polyphony" data-md-component="logo">
      
  <img src="../../assets/lines.png" alt="logo">

    </a>
    Polyphony
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/polyphony-chat/polyproto" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    APIs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            APIs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Chat/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Chat
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Chat
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Core
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Errors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/rate-limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rate limits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/Client-Foreign%20Server%20API/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Client Foreign Server API
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_5">
            <span class="md-nav__icon md-icon"></span>
            Client Foreign Server API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/Client-Home%20Server%20API/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Client Home Server API
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_6">
            <span class="md-nav__icon md-icon"></span>
            Client Home Server API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../APIs/Core/WebSockets/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    WebSockets
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3_7" id="__nav_2_3_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_7">
            <span class="md-nav__icon md-icon"></span>
            WebSockets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/WebSockets/gateway/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../APIs/Core/WebSockets/gateway_events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway Events
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Protocol Specifications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Protocol Specifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    polyproto-core
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    polyproto-core
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-trust-model" class="md-nav__link">
    <span class="md-ellipsis">
      1. Trust model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-apis-and-communication-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      2. APIs and communication protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. APIs and communication protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-client-home-server-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Client-Home server API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-client-foreign-server-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Client-foreign server API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-websockets" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 WebSockets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-federated-identity" class="md-nav__link">
    <span class="md-ellipsis">
      3. Federated Identity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Federated Identity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-federation-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Federation tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-abuse-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Abuse prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-users" class="md-nav__link">
    <span class="md-ellipsis">
      4. Users
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-encryption" class="md-nav__link">
    <span class="md-ellipsis">
      5. Encryption
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Encryption">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      5.1. KeyPackages
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.1. KeyPackages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#511-last-resort-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.1 Last resort KeyPackages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-initial-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Initial authentication
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-keys-and-signatures" class="md-nav__link">
    <span class="md-ellipsis">
      6. Keys and signatures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Keys and signatures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#62-user-identity-keys-and-message-signing" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 User identity keys and message signing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 User identity keys and message signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#621-key-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.1 Key rotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622-message-verification" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.2 Message verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622-multi-device-support" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.2 Multi-device support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-home-server-signed-certificates-for-public-client-identity-keys-id-cert" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Home server signed certificates for public client identity keys (ID-Cert)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3 Home server signed certificates for public client identity keys (ID-Cert)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#631-necessity-of-id-certs" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.1 Necessity of ID-Certs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      6.4 Best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.4 Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#641-signing-keysid-certs" class="md-nav__link">
    <span class="md-ellipsis">
      6.4.1 Signing keys/ID-Certs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#642-home-server-operation-and-design" class="md-nav__link">
    <span class="md-ellipsis">
      6.4.2 Home server operation and design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-account-migration" class="md-nav__link">
    <span class="md-ellipsis">
      7. Account migration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Account migration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-migrating-a-user-account" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Migrating a user account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-re-signing-messages" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Re-signing messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-additional-information" class="md-nav__link">
    <span class="md-ellipsis">
      8. Additional information
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Additional information">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-terminology-used-in-this-document" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Terminology used in this document
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    <span class="md-ellipsis">
      Glossary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    polyproto-chat
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-trust-model" class="md-nav__link">
    <span class="md-ellipsis">
      1. Trust model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-apis-and-communication-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      2. APIs and communication protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. APIs and communication protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-client-home-server-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Client-Home server API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-client-foreign-server-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Client-foreign server API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-websockets" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 WebSockets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-federated-identity" class="md-nav__link">
    <span class="md-ellipsis">
      3. Federated Identity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Federated Identity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-federation-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Federation tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-abuse-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Abuse prevention
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-users" class="md-nav__link">
    <span class="md-ellipsis">
      4. Users
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-encryption" class="md-nav__link">
    <span class="md-ellipsis">
      5. Encryption
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Encryption">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      5.1. KeyPackages
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.1. KeyPackages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#511-last-resort-keypackages" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.1 Last resort KeyPackages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-initial-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Initial authentication
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-keys-and-signatures" class="md-nav__link">
    <span class="md-ellipsis">
      6. Keys and signatures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Keys and signatures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#62-user-identity-keys-and-message-signing" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 User identity keys and message signing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 User identity keys and message signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#621-key-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.1 Key rotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622-message-verification" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.2 Message verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622-multi-device-support" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.2 Multi-device support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-home-server-signed-certificates-for-public-client-identity-keys-id-cert" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 Home server signed certificates for public client identity keys (ID-Cert)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3 Home server signed certificates for public client identity keys (ID-Cert)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#631-necessity-of-id-certs" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.1 Necessity of ID-Certs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      6.4 Best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.4 Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#641-signing-keysid-certs" class="md-nav__link">
    <span class="md-ellipsis">
      6.4.1 Signing keys/ID-Certs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#642-home-server-operation-and-design" class="md-nav__link">
    <span class="md-ellipsis">
      6.4.2 Home server operation and design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-account-migration" class="md-nav__link">
    <span class="md-ellipsis">
      7. Account migration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Account migration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-migrating-a-user-account" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Migrating a user account
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-re-signing-messages" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Re-signing messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-additional-information" class="md-nav__link">
    <span class="md-ellipsis">
      8. Additional information
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Additional information">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-terminology-used-in-this-document" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Terminology used in this document
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    <span class="md-ellipsis">
      Glossary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="polyproto-core-specification">polyproto-core Specification<a class="headerlink" href="#polyproto-core-specification" title="Permanent link">&para;</a></h1>
<p><strong>v0.0.0</strong> - Treat this as an unfinished draft.
<a href="https://semver.org/spec/v2.0.0.html">Semantic versioning v2.0.0</a> is used to version this specification.</p>
<ul>
<li><a href="#polyproto-core-specification">polyproto-core Specification</a></li>
<li><a href="#1-trust-model">1. Trust model</a></li>
<li><a href="#2-apis-and-communication-protocols">2. APIs and communication protocols</a><ul>
<li><a href="#21-client-home-server-api">2.1 Client-Home server API</a></li>
<li><a href="#22-client-foreign-server-api">2.2 Client-foreign server API</a></li>
<li><a href="#23-websockets">2.3 WebSockets</a></li>
</ul>
</li>
<li><a href="#3-federated-identity">3. Federated Identity</a><ul>
<li><a href="#31-federation-tokens">3.1 Federation tokens</a></li>
<li><a href="#32-abuse-prevention">3.2 Abuse prevention</a></li>
</ul>
</li>
<li><a href="#4-users">4. Users</a></li>
<li><a href="#5-encryption">5. Encryption</a><ul>
<li><a href="#51-keypackages">5.1. KeyPackages</a></li>
<li><a href="#511-last-resort-keypackages">5.1.1 Last resort KeyPackages</a></li>
<li><a href="#52-initial-authentication">5.2 Initial authentication</a></li>
</ul>
</li>
<li><a href="#6-keys-and-signatures">6. Keys and signatures</a><ul>
<li><a href="#62-user-identity-keys-and-message-signing">6.2 User identity keys and message signing</a></li>
<li><a href="#621-key-rotation">6.2.1 Key rotation</a></li>
<li><a href="#622-message-verification">6.2.2 Message verification</a></li>
<li><a href="#622-multi-device-support">6.2.2 Multi-device support</a></li>
<li><a href="#63-home-server-signed-certificates-for-public-client-identity-keys-id-cert">6.3 Home server signed certificates for public client identity keys (ID-Cert)</a></li>
<li><a href="#631-necessity-of-id-certs">6.3.1 Necessity of ID-Certs</a></li>
<li><a href="#64-best-practices">6.4 Best practices</a></li>
<li><a href="#641-signing-keysid-certs">6.4.1 Signing keys/ID-Certs</a></li>
<li><a href="#642-home-server-operation-and-design">6.4.2 Home server operation and design</a></li>
</ul>
</li>
<li><a href="#7-account-migration">7. Account migration</a><ul>
<li><a href="#71-migrating-a-user-account">7.1 Migrating a user account</a></li>
<li><a href="#72-re-signing-messages">7.2 Re-signing messages</a></li>
</ul>
</li>
<li><a href="#8-additional-information">8. Additional information</a><ul>
<li><a href="#81-terminology-used-in-this-document">8.1 Terminology used in this document</a></li>
</ul>
</li>
</ul>
<p>The polyproto-core protocol is a home-server-based federation protocol specification centered around the <a href="https://datatracker.ietf.org/doc/html/rfc9420">Messaging Layer Security (MLS) protocol as defined by RFC9420 of the IETF</a>, intended for use in community-centered chat service applications/application implementations. This document is intended to be used as a starting point for developers wanting to develop software which can interoperate with other polyproto-core implementations. Uses of this protocol include Guild-Based, Group-Based and one on one Instant Messaging, Voice over IP, and Video over IP, where your identity is federated between multiple servers.</p>
<p>To correctly implement polyproto-core, you must read and understand the MLS protocol specification (RFC9420).</p>
<p>The structure of this reference document is heavily inspired by the really well written <a href="https://spec.matrix.org/latest">Matrix specification</a>.</p>
<h2 id="1-trust-model">1. Trust model<a class="headerlink" href="#1-trust-model" title="Permanent link">&para;</a></h2>
<p>polyproto-core operates under the following trust assumptions:</p>
<ol>
<li>A user trusts their home server and its admins to keep their data safe from unauthorized access, and to not perform actions which a third party would observe to be performed by the user, without the user's consent.</li>
<li>For a user to distrust their home server, something irregular must have happened, or conflicting information must have been presented to the user.</li>
<li>When joining a guild on another server in the context of federation, a user trusts this server and its admins with a copy of their public profile and with all other unencrypted data sent to the server.</li>
<li>Users trust the other members of an MLS encrypted communications channel with their data, as well as with the metadata attached to the data.</li>
<li>Non-home servers cannot execute actions that might seem to be performed by a foreign user without that user's explicit consent; otherwise, they would be immediately exposed.</li>
<li>A user relies on their home server to act as a certificate authority for their identity keys, without the home server possessing the identity itself.</li>
</ol>
<h2 id="2-apis-and-communication-protocols">2. APIs and communication protocols<a class="headerlink" href="#2-apis-and-communication-protocols" title="Permanent link">&para;</a></h2>
<p>The polyproto-core specification defines a set of APIs. These APIs are the Client-Home server and Client-Foreign server APIs.</p>
<p>Aside from these REST APIs, polyproto-core also uses WebSockets for real-time communication between clients and servers.</p>
<h3 id="21-client-home-server-api">2.1 Client-Home server API<a class="headerlink" href="#21-client-home-server-api" title="Permanent link">&para;</a></h3>
<p>The <em>Client-Home server</em> API of polyproto-core is concerned with authentication- and federation-related issues.
A client in this context is expected to be a user/bot session.</p>
<h3 id="22-client-foreign-server-api">2.2 Client-foreign server API<a class="headerlink" href="#22-client-foreign-server-api" title="Permanent link">&para;</a></h3>
<p>The <em>Client-foreign server</em> API of polyproto-core is used for tasks such as requesting the server's or a user's public key(s) or migrating a user account.
The definition of "client" in this context is broader, since it includes both users/bots and other home servers.</p>
<h3 id="23-websockets">2.3 WebSockets<a class="headerlink" href="#23-websockets" title="Permanent link">&para;</a></h3>
<p>WebSockets in polyproto-core are used for real-time communication between clients and servers. WebSockets are used both in <em>Client-Home server</em> and <em>Client-foreign server</em> communication.</p>
<p>WebSocket connections to polyproto-core servers consist of the following cycle:</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>    +------------------+       1. Establish Connection        +-----------+
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    |      Client      |------------------------------------&gt; |  Gateway  |
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    +------------------+        2. Receive Hello Event        +-----------+
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    |      Client      |&lt;------------------------------------ |  Gateway  |
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                      3. Start Heartbeat Interval (continually)
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a> +-------------------------------------------------------------------------&gt;-+
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a> |  +------------------+       3.1 Send Heartbeat Event       +-----------+  |
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a> ^  |      Client      |------------------------------------&gt; |  Gateway  |  |
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a> |  +------------------+                                      +-----------+  |
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a> |                                                            |              |
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a> |  +------------------+    3.2 Receive Heartbeat ACK Event   +-----------+  |
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a> |  |      Client      |&lt;------------------------------------ |  Gateway  |  v
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a> |  +------------------+                                      +-----------+  |
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a> +-&lt;-------------------------------------------------------------------------+
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    +------------------+      4. Send Identify payload        +-----------+
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    |      Client      |------------------------------------&gt; |  Gateway  |
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    +------------------+        5. Receive Ready Event        +-----------+
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    |      Client      |&lt;------------------------------------ |  Gateway  |
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    +------------------+    6. Disconnect (for any reason)    +-----------+
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    |      Client      |&lt;------------------------------------ |  Gateway  |
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                          7. Resume connection, if eligible
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                           (otherwise: repeat from step 1)
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    +------------------+       7.1 Open new connection        +-----------+
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    |      Client      |------------------------------------&gt; |  Gateway  |
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    +------------------+        7.2 Send Resume Event         +-----------+
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    |      Client      |------------------------------------&gt; |  Gateway  |
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    +------------------+      7.3 Receive Missed Events       +-----------+
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    |      Client      |&lt;------------------------------------ |  Gateway  |
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    +------------------+                                      +-----------+
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    +------------------+      7.4 Receive Resumed Event       +-----------+
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    |      Client      |&lt;------------------------------------ |  Gateway  |
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    +------------------+                                      +-----------+
</code></pre></div>
<p>Fig. 1: Sequence diagram of a WebSocket connection to a polyproto-core server.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>To learn more about polyproto-core WebSockets and WebSocket Events, consult the <a href="/docs/APIs/Core/WebSockets/index.md">WebSockets documentation</a>.</p>
</div>
<h2 id="3-federated-identity">3. Federated Identity<a class="headerlink" href="#3-federated-identity" title="Permanent link">&para;</a></h2>
<p>Federating user identities means that users can fully participate on other instances' guilds and talk to other instances' users.
This means that users can, for example, DM users from another server or join another servers' Guilds. </p>
<p>An identity key defined in <a href="#7-keys-and-signatures">section #7. Keys and signatures</a> is used to sign <a href="#glossary-messages">messages</a> that the user sends to other servers.</p>
<p><strong>Example:</strong>
Say that Alice is on server A, and Bob is on server B. Alice wants to send a <a href="#glossary-messages">message</a> to Bob.</p>
<p>Alice's client will send a message to their home server (Server A), asking it to generate a one-time use federation token for registering on server B. Alice takes this token and sends it to server B. Server B will then ask server A if the token is valid. If all goes well, server B will send a newly generated session token back to Alice's client. Alice's client can then authenticate with server B using this token, and send the message to server B. Server B will then send the message to Bob's client.</p>
<p><div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Alice&#39;s Client                                  Server A              Server B              Bob&#39;s Client
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>|                                               |                     |                     |
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>| Federation token request                      |                     |                     |
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>|----------------------------------------------&gt;|                     |                     |
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>|                                               |                     |                     |
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>|                              Federation token |                     |                     |
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>|&lt;----------------------------------------------|                     |                     |
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>|                              [Federation handshake start]           |                     |
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>|                                               |                     |                     |
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>| Federation token, Public Profile, ID-Cert     |                     |                     |
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>|--------------------------------------------------------------------&gt;|                     |
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>|                                               |                     |                     |
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>|                                               |        Get pubkey   |                     |
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>|                                               |&lt;--------------------|                     |
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>|                                               |                     |                     |
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>|                                               | Server A Pubkey     |                     |
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>|                                               |--------------------&gt;|                     |
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>|                                               |                     |                     |
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>|                                               |                     | Verify fedi-token   |
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>|                                               |                     |-------------------  |
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>|                                               |                     |                  |  |
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>|                                               |                     |&lt;------------------  |
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>|                                               |                     |                     |
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>|                                               |     Session Token   |                     |
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>|&lt;--------------------------------------------------------------------|                     |
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>|                                               |                     |                     |
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>|                             [Federation handshake complete]         |                     |
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>|                                               |                     |                     |
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>| Session Token + Signed message                |                     |                     |
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>|--------------------------------------------------------------------&gt;|                     |
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>|                                               |                     |                     |
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>|                                               |                     | Signed message      |
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>|                                               |                     |--------------------&gt;|
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>|                                               |                     |                     |
</code></pre></div>
Fig. 2: Sequence diagram of a successful federation handshake.</p>
<p>If Alice's session token expires, or if Alice would like to sign in on another device, she can repeat this process of generating a federation token and exchanging it for a session token.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You can read more about the Identity Pubkey and Certificate in <a href="#7-keys-and-signatures">7. Keys and signatures</a>.</p>
</div>
<h3 id="31-federation-tokens">3.1 Federation tokens<a class="headerlink" href="#31-federation-tokens" title="Permanent link">&para;</a></h3>
<p>Federation tokens are generated by the user's home server. The token is a JSON object that contains the following information:</p>
<ul>
<li>The time at which the token expires.</li>
<li>The user's federation ID.</li>
<li>The domain of the server that the token is intended for.</li>
<li>The domain of the user's home server.</li>
<li>A securely-randomly generated nonce</li>
</ul>
<p>The usage of federation tokens prevents replay attacks, as a token is valid only once, only for a limited amount of time, and only for a specific server.</p>
<h3 id="32-abuse-prevention">3.2 Abuse prevention<a class="headerlink" href="#32-abuse-prevention" title="Permanent link">&para;</a></h3>
<p>To protect users from malicious home servers secretly acting on the behalf of non-consenting users,
a mechanism is needed to prevent home servers from generating federation tokens for users without
their consent.</p>
<div class="admonition example">
<p class="admonition-title">Potential abuse scenario</p>
<p>A malicious home server can potentially request a federation token on behalf of one of its
users, and use it to generate a session token on the user's behalf. This is a problem, as the
malicious server can then impersonate the user on another server, as well as read unencrypted
data (such as messages, in the context of a chat application) sent on the other server.</p>
</div>
<p>The above scenario is not unique to polyproto-core, and rather a problem other federated services/
protocols, like ActivityPub, have as well. There is no real solution to this problem, but it can be
mitigated a bit by making it more difficult for malicious home servers to do something like this
without the user noticing.</p>
<p>Polyproto servers should notify users, when a new session token is generated for
them. This would make the malicious home server's actions more noticeable to the user. However, this does
not address the issue of the malicious home server being able to generate a federation token for a server
which you are not yet connected to, as the user would have no way to receive the notification of a 
session token being created for them, if they are not connected to that server. Clients
re-connecting to a server after being offline should be notified of any new session tokens that were
generated for them while they were offline. This <code>NEW_SESSION</code> gateway event should be sent to all
sessions, except for the new session. The <code>NEW_SESSION</code> gateway event should contain the following
information:</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">&quot;ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;IP address of the session&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nt">&quot;user_agent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;User agent of the session&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Timestamp of when the session was created&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="nt">&quot;session_pubkey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Public key of the session&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With proper safety precautions and strong encryption, it is extremely unlikely for a malicious
server to be able to listen in on encrypted conversations, without all users in that 
conversation noticing. MLS's forward secrecy guarantees ensure that, in theory, a malicious
session cannot decrypt any messages sent before its' join epoch. If secrecy or confidentiality
are of concern, users should host their own home server and use end-to-end encryption.</p>
</div>
<h2 id="4-users">4. Users<a class="headerlink" href="#4-users" title="Permanent link">&para;</a></h2>
<p>Each client must have a user associated with it. A user is identified by a unique federation ID (FID), which consists of the user's username (which must be unique on the instance) and the instance's root domain. A FID is formatted as follows: <code>user@domain.tld</code>, which makes for a globally unique user ID. Federation IDs are case-insensitive.</p>
<p>The following regex can be used to validate user IDs: <code>\b([A-Z0-9._%+-]+)@([A-Z0-9.-]+\.[A-Z]{2,})\b</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Validating a federation ID with the above regex does not guarantee that the ID is valid. It only
indicates that the federation ID is formatted correctly.</p>
</div>
<h2 id="5-encryption">5. Encryption<a class="headerlink" href="#5-encryption" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">About MLS</p>
<p>Polyproto offers end-to-end encryption for <a href="#glossary-messages">messages</a> via <a href="https://messaginglayersecurity.rocks/">Message Layer Security (MLS)</a>. polyproto-core compliant servers take on the role of both an Authentication Service and a Delivery Service in the context of MLS.</p>
<p>MLS is a cryptographic protocol that provides confidentiality, integrity, and authenticity guarantees for group messaging applications. It builds on top of the <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet Algorithm</a> and <a href="https://signal.org/docs/specifications/x3dh/">X3DH</a> to provide these security guarantees.</p>
</div>
<p>Implementations of polyproto-core may opt to support encryption to secure communication channels. The selected security protocol for all polyproto-core implementations is the Messaging Layer Security protocol, provided that MLS can feasibly be integrated within the context of the given implementation.</p>
<p>The following sections explain the additional behavior that polyproto-core implementations utilizing MLS must implement.</p>
<h3 id="51-keypackages">5.1. KeyPackages<a class="headerlink" href="#51-keypackages" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The sections 5.1 and 5.1.1 are not exhaustive and do not cover all aspects of MLS and KeyPackages. They exist solely to give a general overview of how KeyPackages are used in polyproto-core.
Please read and understand the MLS specification (RFC9420) to implement polyproto-core correctly.</p>
</div>
<p>A polyproto-core compliant server must store KeyPackages for all users that are registered on the server. The <code>KeyPackage</code> is a JSON object that contains the following information:</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="nt">&quot;protocol_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Version&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="nt">&quot;cipher_suite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;CipherSuite&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">&quot;init_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;HPKEPublicKey&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="nt">&quot;leaf_node&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;LeafNode&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">  </span><span class="nt">&quot;extensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Extensions&gt;&quot;</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li><code>protocol_version</code> is the version of the MLS protocol the <code>KeyPackage</code> is using.</li>
<li><code>cipher_suite</code> is the cipher suite that this KeyPackage is using. Note that a client may store multiple KeyPackages for a single user, to support multiple cipher suites.</li>
<li><code>init_key</code> is a public key that is used to encrypt the group's initial secrets.</li>
<li><code>leaf_node</code> is a signed <code>LeafNodeTBS</code> struct as defined in section <code>7.2. Leaf Node Contents</code> in RFC9420. A <code>LeafNode</code> contains information representing a users' identity, in the form of the users' <strong>ID-Cert</strong> for a given session/client. The <code>LeafNodeTBS</code> is signed using the user's private identity key.</li>
<li><code>extensions</code> can be used to add additional information to the protocol, as defined in section <code>13. Extensibility</code> in RFC9420.</li>
</ul>
<p>A <code>KeyPackage</code> is supposed to be used only once. Servers must ensure the following things:
-  That any <code>KeyPackage</code> is not given out to clients more than once.
-  That the <code>init_key</code> values of all <code>KeyPackages</code> are unique, as the <code>init_key</code> is what makes the <code>KeyPackage</code> one-time use.
-  That the contents of the <code>LeafNode</code> as well as the <code>init_key</code> were signed by the user who submitted the <code>KeyPackage</code>.</p>
<p>Because <code>KeyPackages</code> are supposed to be used only once, it is recommended that servers store multiple valid <code>KeyPackages</code> for each user. A server must notify a client when it is running low on <code>KeyPackages</code> for a user. Consult the Client-Server-API for more information on how servers should request new <code>KeyPackages</code> from clients. Servers should delete a <code>KeyPackage</code> when it is no longer valid.</p>
<h4 id="511-last-resort-keypackages">5.1.1 Last resort KeyPackages<a class="headerlink" href="#511-last-resort-keypackages" title="Permanent link">&para;</a></h4>
<p>A "last resort" <code>KeyPackage</code> is a <code>KeyPackage</code> which can be used multiple times. Such <code>KeyPackages</code> are only to be given out to clients when a server has no more valid, regular <code>KeyPackages</code> available for a user. This is to prevent DoS attacks, where a malicious client could request a large amount of <code>KeyPackages</code> for a user, causing other users not being able to adding the attacked user to an encrypted group or guild channel.</p>
<p>Once a server has given out a "last resort" <code>KeyPackage</code> to a client, the server should request a new "last resort" <code>KeyPackage</code> from the client from the user, once they connect to the server again. The old "last resort" <code>KeyPackage</code> should then be deleted.</p>
<h3 id="52-initial-authentication">5.2 Initial authentication<a class="headerlink" href="#52-initial-authentication" title="Permanent link">&para;</a></h3>
<p>During the initial authentication process, a client must provide at least one <a href="#61-keypackages"><code>KeyPackage</code></a>, as well as one <a href="#611-last-resort-keypackages">"last resort" <code>KeyPackage</code></a> to the server, in addition to the required registration information.</p>
<p>The public identity key inside the <code>LeafNode</code> of this <code>KeyPackage</code> is signed using the home servers' private key, so that home servers act as a certificate authority for their users' keys.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>See <a href="#71-keypackages">7.1. KeyPackages</a> for an outline on what a <code>KeyPackage</code> is, and consult the MLS specification (RFC9420) for more implementation details.</p>
</div>
<h2 id="6-keys-and-signatures">6. Keys and signatures<a class="headerlink" href="#6-keys-and-signatures" title="Permanent link">&para;</a></h2>
<p>It is recommended that keys are to be generated using the <code>EdDSA</code> signature scheme, however, other signature schemes may be used as well.
The MLS protocol used by polyproto-core has a built-in ability to negotiate protocol versions, cipher suites, extensions, credential types, and additional proposal types. For two implementations of polyproto-core to be compatible with each other, they must have overlapping capabilities in these areas.</p>
<h3 id="62-user-identity-keys-and-message-signing">6.2 User identity keys and <a href="#glossary-messages">message</a> signing<a class="headerlink" href="#62-user-identity-keys-and-message-signing" title="Permanent link">&para;</a></h3>
<p>As mentioned section <a href="#3-federated-identity">#3</a>, users must hold on to an identity key pair at all times. This key pair is used to represent a user's identity and to verify <a href="#glossary-messages">message</a> integrity, by having a user sign all <a href="#glossary-messages">messages</a> they send with their private identity key. The key pair is generated by the user, and a user-generated identity key certificate signing request (CSR) is sent to the user's home server when first connecting to the server with a new client, or when rotating keys. The key is stored in the client's local storage. Upon receiving a new identity key CSR, a home server will sign this CSR and send the resulting public key certificate to the client. This certificate is proof that the home server attests to the clients key. Read section <a href="#73-home-server-generated-certificates-for-public-client-identity-keys-id-cert">7.3</a> for more information on the certificate.</p>
<h4 id="621-key-rotation">6.2.1 Key rotation<a class="headerlink" href="#621-key-rotation" title="Permanent link">&para;</a></h4>
<p>A client may choose to rotate their identity key at any time. This is done by generating a new identity key pair, and sending the new public identity key to their home server, as part of a new Certificate Signing Request, at least one new <code>KeyPackage</code> and one corresponding 'last resort' <code>KeyPackage</code>. The home server will then generate the new ID-Cert, send it to the client, and let all clients with a relationship to the client that rotated their identity key know, that this clients' public identity key has changed. The server does this by sending a <a href="/docs/APIs/Core/WebSockets/gateway_events.md#client_key_change"><code>CLIENT_KEY_CHANGE</code></a> gateway event to those clients. For example, in the context of a chat application built with polyproto-chat, a relationship between two clients exists, if the two clients share a guild, a group or a direct <a href="#glossary-messages">message</a> channel, if they are friends, or if they have a pending friend request between each other.</p>
<p>Before sending any <a href="#glossary-messages">messages</a> to a server, a client that performed a key rotation should inform the server of that change, to ensure that the server has the correct ID-Cert cached for the client.</p>
<p>Even though section 7.1 defines that a <code>KeyPackage</code> should be deleted by the server after it has been given out once, servers must keep track of the ID-Certs of all users (and their clients) registered on the server, and must be able to provide a clients' ID-Cert for a given timestamp on request. This is to ensure <a href="#glossary-messages">messages</a> sent by users, even ones sent a long time ago, can be verified by other servers and their users. This is because the public key of a user may change over time and users must sign all <a href="#glossary-messages">messages</a> they send to other servers. Likewise, a client should also keep track of all of its own ID-Certs, to potentially verify its identity in case of a migration.</p>
<p>Signing messages prevents a malicious foreign server from impersonating a user.</p>
<h4 id="622-message-verification">6.2.2 <a href="#glossary-messages">Message</a> verification<a class="headerlink" href="#622-message-verification" title="Permanent link">&para;</a></h4>
<p>Of course, in order for <a href="#glossary-messages">message</a> signing to actually verify <a href="#glossary-messages">message</a> integrity, clients <strong>must</strong> verify the signatures of all <a href="#glossary-messages">messages</a> they receive. This is done by verifying the signature of the <a href="#glossary-messages">message</a> with the ID-Cert of the sender and the ID-Cert of the senders' home server. Clients must also verify that the certificate attached to the <a href="#glossary-messages">message</a> is valid and that the public key in the certificate matches the public key of the sender. </p>
<p><strong>Example:</strong> Given a signed <a href="#glossary-messages">message</a> from Alice, like Bob would receive it from Server B in <a href="#fig-3">Fig. 3</a>, Bob's client would verify the signature of the <a href="#glossary-messages">message</a> like so:</p>
<p><div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Server B                                        Bob                                         Server A
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>|                                               |                                           |
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>| Alice&#39;s signed message                        |                                           |
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>|----------------------------------------------&gt;|                                           |
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>|                                               |                                           |
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>|                       Request Alice&#39;s ID-Cert |                                           |
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>|&lt;----------------------------------------------|                                           |
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>|                                               |                                           |
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>| Alice&#39;s ID-Cert                               |                                           |
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>|----------------------------------------------&gt;|                                           |
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>|                                               |                                           |
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>|                                               | Request Server A ID-Cert                  |
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>|                                               |------------------------------------------&gt;|
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>|                                               |                                           |
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>|                                               |                          Server A ID-Cert |
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>|                                               |&lt;------------------------------------------|
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>|                                               |                                           |
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>|                                               | Verify signature of Alice&#39;s message       |
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>|                                               |------------------------------------       |
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>|                                               |                                   |       |
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>|                                               |&lt;-----------------------------------       |
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>|                                               |                                           |
</code></pre></div>
Fig. 3: Sequence diagram of a successful <a href="#glossary-messages">message</a> signature verification.</p>
<p>Bob's client may now choose to cache Server A's public identity key and Alice's ID-Cert, so that it does not have to request them again in the future, as long as the ID-Cert/Server public key do not change and are not expired. If Bob's client receives another <a href="#glossary-messages">message</a> from Alice, it can now verify the signature of the <a href="#glossary-messages">message</a> with the cached ID-Certs.</p>
<p>If the verification fails, Bob's client should try to re-request the key from Server B first. Should the verification fail again, Bob's client may try to request Alice's public identity key and certificate from Server A (Alice's home server), and try to verify the signature again. Should the verification still not succeed, the <a href="#glossary-messages">message</a> should be treated with extreme caution.</p>
<div class="admonition question">
<p class="admonition-title">Why does Bob's client not request Alice's public identity key from Server A?</p>
<p>Bob's client could request Alice's public identity key from Server A, instead of Server B. However, this is discouraged, as it</p>
<ul>
<li>Generates unnecessary load on Server A; Doing it this way distributes the load of public identity key more fairly, as the server that the <a href="#glossary-messages">message</a> was sent on is the one that has to process the public identity key request.</li>
<li>Would expose unnecessary metadata to Server A; Server A does not need to know who exactly Alice is talking to, and when. Only Server B, Alice and Bob need to know this information. Always requesting the public identity key from Server A might expose this information to Server A.</li>
</ul>
<p>Clients should only use Server A as a fallback for public identity key verification, if Server B does not respond to the request for Alice's public identity key, or if the verification fails with the public identity key from Server B.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>A failed signature verification does not always mean that the <a href="#glossary-messages">message</a> is invalid. It may be that the user's identity key has changed, and that Server B has not yet received the new public identity key for some reason.</p>
</div>
<h4 id="622-multi-device-support">6.2.2 Multi-device support<a class="headerlink" href="#622-multi-device-support" title="Permanent link">&para;</a></h4>
<p>Polyproto servers and clients must implement multi-device support, as defined in the MLS specification (RFC9420).
Clients must not use the same keys on multiple devices. Instead, the MLS protocol assigns a new <code>LeafNode</code> to each device.</p>
<p>Each device provides its own <code>KeyPackages</code> as well as an own identity key. </p>
<h3 id="63-home-server-signed-certificates-for-public-client-identity-keys-id-cert">6.3 Home server signed certificates for public client identity keys (ID-Cert)<a class="headerlink" href="#63-home-server-signed-certificates-for-public-client-identity-keys-id-cert" title="Permanent link">&para;</a></h3>
<p>The home server signed public client identity key certificate, ID-Cert for short, is a public key certificate used to prove the validity of a public identity key. The ID-Cert is a user generated public identity key certificate signing request (CSR), signed by a user's home server, and includes information about the user's identity, as well as the public identity key of the user. Clients can receive an ID-Cert in exchange for a CSR.</p>
<p>A CSR includes the following information:
- The public identity key of the client.
- The federation ID of the user associated with the client.
- The session ID of the client. The session ID is a unique identifier for a session, which does not change when a client rotates their identity keys.
- Optionally, an expiry date for the certificate. This expiry date must be less than or equal to the expiry date of the home servers' public identity key certificate.</p>
<p>The resulting ID-Cert contains the following information, in addition to the information supplied through the CSR:
- Issuer information: The home servers' domain.
- Serial number: A unique identifier for the certificate.
- Signature algorithm: The algorithm used to sign the certificate.
- Signature: The signature of the certificate, generated using the home servers' private identity key.
- Expiry date: The expiry date of the certificate.</p>
<p><div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>                                       Server                                                Client                           
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>                                       |                                                     |                                 
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>                                       |                                                     | Create CSR for own identity key 
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>                                       |                                                     |-------------------------------- 
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>                                       |                                                     |                               | 
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>                                       |                                                     |&lt;------------------------------- 
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                                       |                                                     |                                 
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>                                       |      Request key rotation/CSR signing, CSR attached |                                 
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>                                       |&lt;----------------------------------------------------|                                 
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                                       |                                                     |                                 
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                                       | Verify validity of claims presented in the CSR      |                                 
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                                       |-----------------------------------------------      |                                 
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                                       |                                              |      |                                 
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>                                       |&lt;----------------------------------------------      |                                 
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>                                       |                                                     |                                 
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>                                       | Create ID-Cert for Client                           |                                 
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>                                       |--------------------------                           |                                 
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>                                       |                         |                           |                                 
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>                                       |&lt;-------------------------                           |                                 
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>                                       |                                                     |                                 
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>                                       | Respond with ID-Cert                                |                                 
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>                                       |----------------------------------------------------&gt;|                                 
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>-------------------------------------\ |                                                     |                                 
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>| Send CLIENT_KEY_CHANGE to everyone |-|                                                     |                                 
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>|------------------------------------| |                                                     |                                 
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>                                       |                                                     |                                 
</code></pre></div>
Fig. 4: Sequence diagram depicting the process of a client using a CSR to request a new ID-Cert from their home server.</p>
<h4 id="631-necessity-of-id-certs">6.3.1 Necessity of ID-Certs<a class="headerlink" href="#631-necessity-of-id-certs" title="Permanent link">&para;</a></h4>
<p>The addition of a certificate may seem ubiquitous, but it is necessary to prevent a malicious foreign server from abusing public identity key caching to impersonate a user. Consider the following example which employs foreign server public identity key caching, but no home server issued identity key certificates:</p>
<div class="admonition example">
<p class="admonition-title">Potential abuse scenario</p>
<p>A malicious foreign server B can fake a <a href="#glossary-messages">message</a> from Alice (Home server: Server A) to Bob (Home Server: Server B), by generating a new identity key pair and using it to sign the malicious <a href="#glossary-messages">message</a>. The foreign server then sends that <a href="#glossary-messages">message</a> to Bob, who will then request Alice's public identity key from Server B, who will then send Bob the malicious public identity key. Bob will succeed in verifying the signature of the <a href="#glossary-messages">message</a>, and not notice that the <a href="#glossary-messages">message</a> is malicious.</p>
</div>
<p>The above scenario is not possible with home server issued identity key certificates, as the malicious server cannot generate an identity key pair for Alice which is signed by Server A.</p>
<p>Should the expected lifetime of a servers' identity key come to an early end, perhaps due to being leaked and therefore needing to be rotated, the server should generate a new identity key pair + ID-Cert and send a <a href="/docs/APIs/Core/WebSockets/gateway_events.md#server_key_change"><code>SERVER_KEY_CHANGE</code></a> gateway event, as well as a <a href="/docs/APIs/Core/WebSockets/gateway_events.md#low_key_packages"><code>LOW_KEY_PACKAGES</code></a> event to all clients. The clients should then also re-generate their identity keys and request a new ID-Cert from the server (via sending a CSR), as well as respond to the <a href="/docs/APIs/Core/WebSockets/gateway_events.md#low_key_packages"><code>LOW_KEY_PACKAGES</code></a> event correctly.</p>
<h3 id="64-best-practices">6.4 Best practices<a class="headerlink" href="#64-best-practices" title="Permanent link">&para;</a></h3>
<h4 id="641-signing-keysid-certs">6.4.1 Signing keys/ID-Certs<a class="headerlink" href="#641-signing-keysid-certs" title="Permanent link">&para;</a></h4>
<ul>
<li>Instance/user signing keys should be rotated regularly (every 3-6 months). This is to ensure that a compromised key can only be used for a limited amount of time.</li>
<li>When a server is asked to generate a new ID-Cert for a user, it must make sure that the CSR is valid and, if set, has an expiry date which is less than or equal to the expiry date of the server's own ID-Cert.</li>
<li>Due to the fact that a <code>SERVER_KEY_CHANGE</code> gateway event is bound to generate a lot of traffic, servers should only manually generate a new identity key pair when absolutely necessary and instead choose a fitting expiry date interval for their identity key certificates. It might also be a good idea to stagger the sending of <code>SERVER_KEY_CHANGE</code> gateway events, to prevent a server from initiating a DDoS attack on itself.</li>
<li>When a client or server receives the information that a user clients' identity key has been changed, the client/server in question should update their cached ID-Cert for the user in question, taking into account the session ID of the new identity key pair.</li>
</ul>
<h4 id="642-home-server-operation-and-design">6.4.2 Home server operation and design<a class="headerlink" href="#642-home-server-operation-and-design" title="Permanent link">&para;</a></h4>
<ul>
<li>Employ a caching layer for your home server to handle the potentially large amount of requests for public key certificates without putting unnecessary strain on the database.</li>
</ul>
<h2 id="7-account-migration">7. Account migration<a class="headerlink" href="#7-account-migration" title="Permanent link">&para;</a></h2>
<p>Account migration allows users to move their account and associated data to another identity.
This allows users to switch home servers while not losing ownership of <a href="#glossary-messages">messages</a> sent by them.</p>
<p>Migrating an account is done with the following steps:</p>
<ol>
<li>The user creates a new account on a new home server.</li>
<li>The user requests the migration from the new home server, specifying the old account's
   federation ID.</li>
<li>The old user account confirms the migration request by sending a signed API request to the new home
   server. The confirmation contains the federation ID of the new account.</li>
<li>The new server sends this information to the old server, which then sends the new server all
   information associated with the old account. 
   The old server now forward requests regarding the old account to the new server.
   Alternatively, if the old server is shut down, the new server can request the information
   from the old user directly.</li>
<li>The old account can now request the resigning of its <a href="#glossary-messages">messages</a>, transferring ownership of the
   <a href="#glossary-messages">messages</a> to the new account. To have all <a href="#glossary-messages">messages</a> from a server re-signed, a user must
   prove that they are the owner of the private keys used to sign the <a href="#glossary-messages">messages</a>.</li>
</ol>
<h3 id="71-migrating-a-user-account">7.1 Migrating a user account<a class="headerlink" href="#71-migrating-a-user-account" title="Permanent link">&para;</a></h3>
<p><div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Server_A                               Alice_A                                                Server_B                                            Alice_B 
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>|                                      |                                                      |      Migration Request (Signed, Alice_A-&gt;Alice_B) |
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>|                                      |                                                      |&lt;--------------------------------------------------|
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>|                                      | Migration Request (Signed, Alice_A-&gt;Alice_B)         |                                                   |
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>|                                      |-----------------------------------------------------&gt;|                                                   |
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>|       Fetch full profile of Alice_A (Attached: Migration Request, Signed, Alice_A-&gt;Alice_B) |                                                   |
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>|&lt;--------------------------------------------------------------------------------------------|                                                   |
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>| Verify Signed Migration Request      |                                                      |                                                   |
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>|--------------------------------      |                                                      |                                                   |
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>|                               |      |                                                      |                                                   |
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>|&lt;-------------------------------      |                                                      |                                                   |
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>| Full profile of Alice_A              |                                                      |                                                   |
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>|--------------------------------------------------------------------------------------------&gt;|                                                   |
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>|                                      |                                                      | Verify, replace Alice_B profile with Alice_A      |
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>|                                      |                                                      |---------------------------------------------      |
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>|                                      |                                                      |                                            |      |
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>|                                      |                                                      |&lt;--------------------------------------------      |
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>|                                      |                                                      | New account data                                  |
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>|                                      |                                                      |--------------------------------------------------&gt;|
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>| Deactivate Alice_A&#39;s account         |                                                      |                                                   |
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>|-----------------------------         |                                                      |                                                   |
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>|                            |         |                                                      |                                                   |
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>|&lt;----------------------------         |                                                      |                                                   |
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>|                                      |                                                      |                                                   |
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>| Set up redirect from Alice_A to Alice_B                                                     |                                                   |
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>|--------------------------------------------------------------------------------------------&gt;|                                                   |
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>|                                      |                                                      |                                                   |
</code></pre></div>
Fig. 5: Sequence diagram depicting a successful migration of Alice_A's account to Alice_B's account, where Server A is reachable and cooperative.</p>
<p>Alternatively, if Server A is offline or deemed uncooperative, the following sequence diagram depicts how the migration can be done without Server A's cooperation:</p>
<p><div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Server_A     Alice_A                                                                          Server_B                                            Alice_B 
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>|            |                                                                                |      Migration Request (Signed, Alice_A-&gt;Alice_B) |
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>|            |                                                                                |&lt;--------------------------------------------------|
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>|            | Migration Request (Signed, Alice_A-&gt;Alice_B)                                   |                                                   |
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>|            |-------------------------------------------------------------------------------&gt;|                                                   |
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>|       Fetch full profile of Alice_A (Attached: Migration Request, Signed, Alice_A-&gt;Alice_B) |                                                   |
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>|&lt;--------------------------------------------------------------------------------------------|                                                   |
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>|            |                                                                                | Wait for response...                              |
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>|            |                                                                                |---------------------                              |
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>|            |                                                                                |                    |                              |
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>|            |                                                                                |&lt;--------------------                              |
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>|            |                       Server_A offline/not cooperative, send profile or abort? |                                                   |
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>|            |&lt;-------------------------------------------------------------------------------|                                                   |
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>|            | Full profile of Self                                                           |                                                   |
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>|            |-------------------------------------------------------------------------------&gt;|                                                   |
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>|            |                                                                                | Verify, replace Alice_B profile with Alice_A      |
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>|            |                                                                                |---------------------------------------------      |
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>|            |                                                                                |                                            |      |
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>|            |                                                                                |&lt;--------------------------------------------      |
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>|            |                                                                                |                                                   |
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>|            |                                                                                | New account data                                  |
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>|            |                                                                                |--------------------------------------------------&gt;|
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>|            |                                                                                |                                                   |
</code></pre></div>
Fig. 6: Sequence diagram depicting a successful migration of Alice_A's account to Alice_B's account, where Server A is unreachable or uncooperative.</p>
<div class="admonition question">
<p class="admonition-title">If the old home server is not needed for the migration, why try to contact it in the first place?</p>
<p>It is generally preferrable to have the old home server cooperate with the migration, as it
allows for a more seamless migration. A cooperative homeserver will be able to provide the new
home server with all information associated with the old account. It can also forward requests
regarding the old account to the new server, which makes the process more seamless for other
users. The "non-cooperative homeserver migration method" is only a last resort.</p>
</div>
<h3 id="72-re-signing-messages">7.2 Re-signing <a href="#glossary-messages">messages</a><a class="headerlink" href="#72-re-signing-messages" title="Permanent link">&para;</a></h3>
<p>Re-signing <a href="#glossary-messages">messages</a> is the process of transferring ownership of <a href="#glossary-messages">messages</a> from an old account to the
new, migrated account. The process requires some coordination between the new and old accounts, 
and can only be initiated by the old account. </p>
<p>To initiate the process, the old account must send an API request to the server where <a href="#glossary-messages">messages</a>
should be re-signed. The request must contain the federation ID of the new account. The server will 
then respond with a list of all keys that were used to sign <a href="#glossary-messages">messages</a> sent by the old account. The
old account will then need to prove that it is in possession of the private keys that were used to
sign the <a href="#glossary-messages">messages</a>. This is done by signing a challenge string with the private keys. The server will
then verify the signature, and, if the verification is successful, grant the new account the ability
to re-sign all <a href="#glossary-messages">messages</a> sent by the old account which were signed with the provided keys.</p>
<p>Re-signing <a href="#glossary-messages">messages</a> mustn't overwrite the old signature. Instead, a new variant of the <a href="#glossary-messages">message</a> must
be created, which contains the new signature.</p>
<p><div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Alice_A                                              Server_C                                                              Alice_B                                                 
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>| Request allow message re-signing for Alice_B       |                                                                     |                                                     
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>|---------------------------------------------------&gt;|                                                                     |                                                     
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>|          List of keys to verify + challenge string |                                                                     |                                                     
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>|&lt;---------------------------------------------------|                                                                     |                                                     
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>| Completed challenge for each key on the list       |                                                                     |                                                     
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>|---------------------------------------------------&gt;|                                                                     |                                                     
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>|                                                    | Verify challenge, unlock re-signing for Alice_B                     |                                                     
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>|                                                    |------------------------------------------------                     |                                                     
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>|                                                    |                                               |                     |                                                     
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>|                                                    |&lt;-----------------------------------------------                     |                                                     
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>|                                                    |                   Request message re-signing for Alice_A&#39;s messages |                                                     
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>|                                                    |&lt;--------------------------------------------------------------------|                                                     
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>|                                                    | List of old messages (including old signatures + certificates)      |                                                     
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>|                                                    |--------------------------------------------------------------------&gt;|                                                     
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>|                                                    |                                                                     | Verify that Server_C has not tampered with messages 
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>|                                                    |                                                                     |---------------------------------------------------- 
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>|                                                    |                                                                     |                                                   | 
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>|                                                    |                                                                     |&lt;--------------------------------------------------- 
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>|                                                    |                                                                     | Re-sign messages with own keys                      
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>|                                                    |                                                                     |-------------------------------                      
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>|                                                    |                                                                     |                              |                      
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>|                                                    |                                                                     |&lt;------------------------------                      
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>|                                                    |                                                        New messages |                                                     
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>|                                                    |&lt;--------------------------------------------------------------------|                                                     
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>|                                                    |                                                                     |                                                     
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>|                                                    | Verify that only FID and signature related fields have changed      |                                                     
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>|                                                    |---------------------------------------------------------------      |                                                     
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>|                                                    |                                                              |      |                                                     
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>|                                                    |&lt;--------------------------------------------------------------      |                                                     
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>|                                                    |                                                                     |                                                     
</code></pre></div>
Fig. 7: Sequence diagram depicting the re-signing procedure.</p>
<h2 id="8-additional-information">8. Additional information<a class="headerlink" href="#8-additional-information" title="Permanent link">&para;</a></h2>
<h3 id="81-terminology-used-in-this-document">8.1 Terminology used in this document<a class="headerlink" href="#81-terminology-used-in-this-document" title="Permanent link">&para;</a></h3>
<ul>
<li><a id="glossary-messages"><strong>Message</strong></a>: In the context of this protocol specification, a message is any piece of data sent by a client that is intended to be identifiable as being sent by a specific user. To qualify as a "message", this piece of data must also, at any point in time, and also if only briefly, be visible to other users and/or the unauthenticated public.</li>
</ul>
<h2 id="glossary">Glossary<a class="headerlink" href="#glossary" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Client</strong> - A device or session that is used by a user or bot to connect to a server.</li>
<li><strong>Federation token</strong> - A one-time use token generated by a user's home server, which is used to authorize/identify a user on a foreign server.</li>
<li><strong>Foreign server</strong> - A polyproto-core server that a user is not registered on - essentially a third party.</li>
<li><strong>Foreign user</strong> - A user registered on a foreign server.</li>
<li><strong>Home server</strong> - The server that a user is registered on.</li>
<li><strong>Identity Key</strong> - A key pair which represents a user's identity for a given session. It is used to sign messages and to encrypt messages for the user.</li>
<li><strong>polyproto</strong> - The combination of the polyproto-core and polyproto-chat protocols and APIs.</li>
<li><strong>polyproto-chat</strong> - The chat-API used by polyproto. It defines the routes and capabilities of the chat-API used by polyproto.</li>
<li><strong>polyproto-core</strong> - The core federation protocol and APIs of polyproto, enabling identification and authorization on 'foreign' servers. It is independent of the chat-API used.</li>
<li><strong>User</strong> - An entity represented by a federation ID, registered on a home server.</li>
</ul>
<p><strong>The below creation- and update-times are not accurate. This is only an issue on this page. Please have a look at the <a href="https://github.com/polyphony-chat/polyproto/commits/main/SPECIFICATION.md">commit history</a> to view when this document was last updated.</strong></p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-01-13T22:37:45+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-01-13</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2023-12-23T17:48:43+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-12-23</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "toc.follow", "navigation.top", "search.suggest", "content.tooltips", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="../../assets/external/unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
    
  </body>
</html>